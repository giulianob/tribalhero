<project name="gameserver" default="compile" basedir="." xmlns="antlib:org.apache.tools.ant"  xmlns:antcontrib="antlib:net.sf.antcontrib">
	
    <taskdef resource="net/sf/antcontrib/antlib.xml" uri="antlib:net.sf.antcontrib">
      <classpath>
        <pathelement location="${basedir}/Lib/ant/ant-contrib.jar"/>
      </classpath>
    </taskdef>
    
    <description>Game server build</description>
	
	<target name="init">
		<echo message="Building from ${basedir}" />
	
		<tstamp />
		
		<fail unless="game.version">Version not specified</fail>
		
		<antcontrib:propertyregex property="major_version" input="${game.version}" regexp="^([0-9]*).([0-9]*)$" select="\1" />
		<antcontrib:propertyregex property="revision" input="${game.version}" regexp="^([0-9]*).([0-9]*)$" select="\2" />
	</target>
	
	<target name="compile" depends="init">
		<replaceregexp file="${basedir}/Game/Setup/Config.cs" match="client_min_version(.*)" replace="client_min_version = ${major_version};" byline="true" />		
		<replaceregexp file="${basedir}/Game/Setup/Config.cs" match="client_min_revision(.*)" replace="client_min_revision = ${revision};" byline="true" />				
	
		<exec executable="xbuild" failonerror="true" dir="${basedir}">
			<arg value="Game.sln" />
			<arg value="/t:Common:Rebuild" />
			<arg value="/t:Persistance:Rebuild" />
			<arg value="/t:Game:Rebuild" />
			<arg value="/t:CSVToXML:Rebuild" />
			<arg value="/t:Tools/ConsoleSimulator:Rebuild" />
			<arg value="/t:Tests/Common_Testing:Rebuild" />
			<arg value="/t:Tests/Testing:Rebuild" />
			<arg value="/t:Tools/DatabaseGenerator:Rebuild" />
			<arg value="/t:Tools/GraphGenerator:Rebuild" />
			<arg value="/t:Launcher:Rebuild" />
			<arg value="/t:LauncherService:Rebuild" />			

			<arg value="/p:Configuration=Release" />
			<arg value="/p:BuildProjectReferences=false" />
		</exec>
	</target>
	
	<target name="deploy" if="deploydir" depends="compile">
		<mkdir dir="${deploydir}" />	

		<exec dir="${basedir}" executable="mono" failonerror="true">
			<arg value="${basedir}/GraphGenerator/bin/Release/GraphGenerator.exe" />
			<arg value="--output=${deploydir}/graphoutput" />
			<arg value="--img=${basedir}/graphics/buildings" />
			<arg value="--img=${basedir}/graphics/units" />
			<arg value="--img=${basedir}/graphics/icons/props" />
		</exec>
		
		<exec dir="${basedir}" executable="mono" failonerror="true">
			<arg value="${basedir}/DatabaseGenerator/bin/Release/DatabaseGenerator.exe" />
			<arg value="--output=${deploydir}/databaseoutput" />
			<arg value="--img=${basedir}/graphics/buildings" />
			<arg value="--img=${basedir}/graphics/units" />
			<arg value="--img=${basedir}/graphics/icons/props" />
		</exec>					
			
		<zip destfile="${deploydir}/Launcher.zip">
			<zipfileset dir="${basedir}/Launcher/bin/Release" prefix="bin" />
			<zipfileset dir="${basedir}/conf" prefix="conf" />			
		</zip>
		
		<zip destfile="${deploydir}/LauncherService.zip">
			<zipfileset dir="${basedir}/LauncherService/bin/Release" prefix="bin" />
			<zipfileset dir="${basedir}/conf" prefix="conf" />			
		</zip>		
		
		<zip destfile="${deploydir}/Database.zip">
			<zipfileset dir="${deploydir}/databaseoutput/"/>
		</zip>
		<zip destfile="${deploydir}/Graph.zip">
			<zipfileset dir="${deploydir}/graphoutput/" includes="*.png" />			
		</zip>
	</target>	
</project>